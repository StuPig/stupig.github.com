<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="keywords" content="" />
    <title>
        
            StuPig
        
    </title>
    <link rel="stylesheet" href="/stylesheets/master.css" type="text/css" media="screen" charset="utf-8"/>
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="screen" charset="utf-8"/>
    <script src="/javascripts/jquery.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/jquery.github.js" type="text/javascript" charset="utf-8"></script>
    <link rel='alternate' type='application/rss+xml' href='atom.xml' />
  </head>
  <body>
    <div id='wrapper'>
      <div id='header' style='background: #F8F8F8;'>
        <h1><a href='/'>StuPig</a></h1>
        <div id='menu'>
          <ul>
            <li><a href='/index.html' id='home_link' title='Home'>Home</a></li>
            <li><a href='http://github.com/stupig' target='_blank' title='GitHub' rel='me' id='github_link'>GitHub</a></li>
            <li><a href='https://twitter.com/#!/GaryFromChina' title='Twitter' target='_blank' rel='me' id='twitter_link'>twitter</a></li>
            <li><a href='http://stackoverflow.com/users/1251340/stupig' title='stackoverflow' target='_blank' rel='me' id='stackoverflow_link'>stackoverflow</a></li>
            <li><a href='/lab' id='lab_link' title='Lab'>Lab</a></li>
            <li><a href='/share' id='share_link' title='Share'>Share</a></li>
<!--             <li><a href='http://about.me/stupig' title='about.me' target='_blank' rel='me' id='aboutme_link'>about.me</a></li>
 -->          </ul>
        </div>
      </div>
      <div id='navigater'>
      </div>
      <div id='content'>
        <div class='home_box' id='home_left' style='margin-left:0.3em'>

  <div class="posts">
    <span class='date'>22 Oct 2012</span>
    <h1 id='title'><a href="/blog/2012/10/22/what-i-should-learned/" title="我要学会的">我要学会的</a></h1>
    <div class="body" style='background: #FFF;'>
      <div id="post_content_overflow"><h4>我做的大错特错的</h4>

<ol>
<li><p>没胆量在做错事情的时候去承担，第一时间想到的不是去面对问题，而是去逃避</p></li>
<li><p>没有自己的主见，总是为别人所动摇</p></li>
<li><p>遇到问题，总是指望别人能帮到你，没人能帮你，自己的错误要自己扛</p></li>
<li><p>不吸取教训，屡教不改，还放任自流</p></li>
</ol>


<h4>我应该要学会做的</h4>

<ol>
<li><p>做一件事情前，不要只照顾眼前，要从长远看，做这件事情究竟对自己好，还是让自己更糟</p></li>
<li><p>尽自己所能去做对的事情，不管结果怎样</p></li>
<li><p>吸取教训</p></li>
</ol>

</div>
      <div class='quick-read-more'><a href='/blog/2012/10/22/what-i-should-learned/'>阅读全文...</a></div>
    </div><br />
    </div>
    
  <div class="posts">
    <span class='date'>21 Oct 2012</span>
    <h1 id='title'><a href="/blog/2012/10/21/i%27m-a-stupig-guy.md/" title="i'm a stupig guy">i'm a stupig guy</a></h1>
    <div class="body" style='background: #FFF;'>
      <div id="post_content_overflow">i'm so upset to point out what i'v learned about myself these days:

#####I'm just tooooooooooooooooooooooo lazy, too lazy to integrate into the world of others. what i wanna is someone to integrate into mine. i'm a stupid guy full of negative energy

#####i'm too scared to write this in Chinese. :(
</div>
      <div class='quick-read-more'><a href='/blog/2012/10/21/i%27m-a-stupig-guy.md/'>阅读全文...</a></div>
    </div><br />
    </div>
    
  <div class="posts">
    <span class='date'>26 Aug 2012</span>
    <h1 id='title'><a href="/blog/2012/08/26/use-nginx-reverse-proxy-for-xmlhttprequest/" title="Web服务器反向代理——跨域的另一种方案">Web服务器反向代理——跨域的另一种方案</a></h1>
    <div class="body" style='background: #FFF;'>
      <div id="post_content_overflow"><h4>前情回顾</h4>

<p>之前在上一篇”<a href="http://stupig.me/blog/2012/08/20/web-proxy-for-cross-domain-xmlhttprequest-calls/">后端代理——跨域的另一种方案</a>“一文中简单介绍了下前端跨域的几种实现方案，并详细介绍了“后端代理”的方式，协助前端跨域的方案。</p>

<p>真实的环境中更多的不是非0即1的二进制，而是适合与更适合。尤其是在做方案选取的时候，各种方案各有优劣，更多是去根据自己的场景选取一个最适合自己的。重新回到前端跨域问题，我在后端代理——跨域的另一种方案中也对各种方案做了简单的总结。欢迎大家拍砖。</p>

<hr />

<h4>需求</h4>

<p>最近在<code>Hybrid App</code>项目的开发过程中，数据需要跟“移动后台API'”同学获取，因为我俩都是本地开发，本地起Web服务，因此，我在请求他（http://192.168.60.31:8602/api/v3/deal/search/substore/129180）的时候就果断碰到了跨域问题。</p>

<h4>方案选取</h4>

<p>因为目前业务功能涉及到的还只是<code>GET</code>请求，所以我首先想到通过<code>JSONP</code>的方式解决。但是很快遭到了后台同学的拒绝，因为这不是改动大或小、简不简单的问题，而是这种任务就不应该又后台同学来做。</p>

<p>这回污染了后端<code>API</code>的代码。因为不能污染后台的代码，我似乎只有一条选择，便是之前提到的<code>后端代理</code>的方式，但是想到以后只要涉及到<code>移动后台API</code>的开发，我就要一直维护这份<code>代理</code>的代码，我也挺头疼。</p>

<p>想到既然可以通过后端代理，那样似乎代表着可以利用比后端更底层，与前端<code>HTTP</code>请求更亲近的Web服务器去做反向代理，来实现跨域？简单查了下资料，发现网上早有先例。</p>

<h4>反向代理</h4>

<p>“反向代理（Reverse Proxy）是指以代理服务器来接受<code>Internet</code>上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给<code>Internet</code>请求连接的客户端，此时，代理服务器对外就表现为一个服务器。”——《实战Nginx》</p>

<h4>正向代理</h4>

<p>既然有反向代理，就肯定有正向代理。什么叫正向代理呢？</p>

<p>正向代理（Forward Proxy），通常都被简称为代理，就是在用户无法正常访问外部资源，比方说受到GFW的影响无法访问twitter的时候，我们可以通过代理的方式，让用户绕过防火墙，从而连接到目标网络或者服务。</p>

<h4>反向代理VS正向代理</h4>

<p><img title="反向代理VS正向代理" alt="反向代理VS正想代理" src="/post_images/2012/08/Forward-Proxy-vs-Reverse-Proxy.jpeg" width="600"  /></p>

<h4>反向代理的优势</h4>

<ol>
<li>请求的统一控制，包括设置权限、过滤规则等</li>
<li>区分动态和静态可缓存内容</li>
<li>隐藏内部服务真实地址，暴露在外的只是反向代理服务器地址</li>
<li>实现负载均衡，内部可以采用多台服务器来组成服务器集群，外部还是可以采用一个地址访问</li>
<li>解决Ajax跨域问题</li>
<li>作为真实服务器的缓冲，解决瞬间负载量大的问题</li>
</ol>


<h4>反向代理服务器的配置</h4>

<p>此处以<code>Nginx</code>和<code>Apache</code>为例，<code>Lighttpd</code>等<code>Web</code>服务器同样支持。</p>

<p><strong>Nginx</strong></p>

<p><code>proxy_set_header</code>是向反向代理的后端<code>Web</code>服务器请求时，添加制定的header头信息。当请求的后端<code>Web</code>服务器有多个基于域名的虚拟主机时，要通过添加指定的<code>Host</code>来区分。</p>

<p>在请求和响应头中添加<code>X-Forwarded-For</code>原始请求的地址，因为使用了反向代理之后，后端<code>Web</code>服务器（以PHP为例）就不能通过<code>$_SERVER["REMOTE_ADDR"]</code>变量来获取用户真实的<code>IP</code>了。</p>

<p>此时<code>$_SERVER["REMOTE_ADDR"]</code>指向的是反向代理的<code>Nginx</code>服务器<code>IP</code>，通过<code>$_SERVER["X-Forwarded-For"]</code>来获取</p>

<p><strong>Apache</strong></p>

<p>ProxyPass和ProxyPassReverse指令都是反向代理需要的配置。</p>

<p> ProxyPass用于将一个远程服务器映射到本地服务器的URL空间中。</p>

<p>而ProxyPassReverse主要解决后端服务器重定向造成的绕过反向代理的问题，在后端服务器会进行服务器端跳转时使用，对HTTP重定向时回应中的Location、Content-Location和URI头里的URL进行调整。</p>

<p><strong>参考资料</strong></p>

<p><a href="http://blog.csdn.net/hfahe/article/details/5721320">用Nginx和Apache的反向代理解决Ajax的跨域问题</a></p>

<p><a href="http://book.douban.com/subject/4251875/">《实战Nginx》</a></p>

<p><a href="http://wiki.nginx.org/Chs">《Nginx中文维基》</a></p>

<p><a href="http://www.celinio.net/techblog/?p=1027">Proxy vs Reverse-proxy</a></p>

<p><a href="http://blog.csdn.net/luochuan/article/details/7217837">关于反向代理</a></p>
</div>
      <div class='quick-read-more'><a href='/blog/2012/08/26/use-nginx-reverse-proxy-for-xmlhttprequest/'>阅读全文...</a></div>
    </div><br />
    </div>
    
  <div class="posts">
    <span class='date'>25 Aug 2012</span>
    <h1 id='title'><a href="/blog/2012/08/25/i-do-not-even-know-myself/" title="我不懂我自己">我不懂我自己</a></h1>
    <div class="body" style='background: #FFF;'>
      <div id="post_content_overflow"><p>音乐、文字、照片、电影，甚至是一句再普通不过的对白，都很容易把自己带入一种情愫，拨乱心弦</p>

<p>一直追求的放下，一直希望的内心平和，在一段文字面前，在夹带着回忆和憧憬的情愫下，消失的无影无踪。
取而代之的是内心的悸动。或许这就是共鸣吧，很多东西我不知道我知道，很多情感我不知道我了解。这时候才发现，我真的不懂我自己</p>

<pre><code>以为自己很狂妄，
    却依旧为伊消得人憔悴

以为自己很专一
    一路走来却是薄情郎

以为自己喜新厌旧
    随意勾起的过往，却仍无法释然

以为自己陈世美
    时隔多年，却仍为伊耿耿于怀

以为自己很胆怯
    却总是很鲁莽

以为自己很勇敢
    每次却总小心翼翼

以为自己很洒脱
    却一直在纠结

或许一直骗别人
    自己却当了真

或许一直把自己骗
    自己却从未当真

----
我不懂我自己，就像你也不懂你自己
</code></pre>
</div>
      <div class='quick-read-more'><a href='/blog/2012/08/25/i-do-not-even-know-myself/'>阅读全文...</a></div>
    </div><br />
    </div>
    
  <div class="posts">
    <span class='date'>20 Aug 2012</span>
    <h1 id='title'><a href="/blog/2012/08/20/web-proxy-for-cross-domain-xmlhttprequest-calls/" title="后端代理——跨域的另一种方案">后端代理——跨域的另一种方案</a></h1>
    <div class="body" style='background: #FFF;'>
      <div id="post_content_overflow"><h3>跨域的前端实现方案有很多种</h3>

<ol>
<li><p>跨子域可以采用<code>iframe proxy</code>的方式，支持<code>GET</code>和<code>POST</code>，支持异步<code>POST</code>。缺点是：范围较窄，限定在“跨子域”，而且需要在目标服务器增加额外的文件。</p></li>
<li><p>JSONP的方式，支持双向通信。只支持<code>GET</code>。缺点是：不支持<code>POST</code>，同时需要目标服务器在服务端支持。<a href="http://www.ibm.com/developerworks/cn/web/wa-aj-jsonp1/">http://www.ibm.com/developerworks/cn/web/wa-aj-jsonp1/</a></p></li>
<li><p><code>iframe</code>的<code>window.name</code>的方式，支持跨主域。缺点是：不支持<code>POST</code>，不过已经很赞了：）<a href="http://www.planabc.net/2008/09/01/window_name_transport/">http://www.planabc.net/2008/09/01/window_name_transport/</a></p></li>
<li><p>HTML5 postMessage，支持双向通信。缺点是：仅限于HTML5。结合<code>window.name</code>的方式，就很赞了~<a href="http://js8.in/752.html">http://js8.in/752.html</a></p></li>
<li><p><code>iframe</code> + <code>location.hash</code>的方式跨主域，功能强大，兼容性好，支持跨域的<code>js</code>调用,支持双向通信。缺点是：太复杂，会嵌套太多的<code>iframe</code>，同时数据直接写在<code>url</code>中，数据大小受限而且数据暴露在外。<a href="http://jj7jj7jj.iteye.com/blog/1120231http://www.nowamagic.net/librarys/veda/detail/165">http://jj7jj7jj.iteye.com/blog/1120231http://www.nowamagic.net/librarys/veda/detail/165</a></p></li>
<li><p>利用<code>Flash</code>跨域，优点是支持强大，相对简单。缺点是：依赖flash，需要在服务器更目录放置<code>crossdomain.xml</code>文件。 <a href="http://www.colorhook.com/blog/?p=789">http://www.colorhook.com/blog/?p=789</a></p></li>
</ol>


<hr />

<h3>需求：</h3>

<p>讲完了前端跨域的实现方案，再讲下我的需求：</p>

<p><strong>本地调用美团的<code>deal</code>的<code>API</code>，然后获取<code>deal</code>的列表。</strong></p>

<p>最开始，我想通过JSONP的方式去做，但是发现<code>API</code>不支持<code>callback</code>，于是，我手动在<code>dev</code>上输出时为它添加了支持：</p>

<div class="highlight"><pre><code class="php"><span class="x">    echo (isset($_GET[&#39;callback&#39;]) ? $_GET(&#39;callback&#39;).&#39;(&#39;.$jsonData.&#39;)&#39; : $jsonData);</span>
</code></pre>
</div>


<p>然后问题解决了。</p>

<p>但是，当我回到自己的蜗居，因为没有公司<code>VPN</code>，是访问不到公司内网环境的。于是新的需求出现了：</p>

<p><strong>如何在不修改服务器资源文件的情况下，获取到<code>deal</code>列表。</strong></p>

<h3>方案选取</h3>

<p>我测试了下，实际上浏览器直接访问线上给手机端的<code>API</code>地址，是可以正常获取到数据。这意味着，它只是一个再普通不过的<code>GET</code>请求。
那我的方案有哪些呢？楼上的<code>3</code>和<code>4</code>（<code>5</code>我担心数据容量限制）。考虑到我要去不断操作<code>iframe</code>，我也不太想去做。</p>

<p>那还有吗？是的，我们可以通过后端代理的方式，将跨域的任务交给后端。</p>

<p>与前端不同，用proxy在服务器端协助是一种后端的跨域请求方案，可以降低前端开发的压力。</p>

<h3>利用后端proxy跨域请求的原理</h3>

<p> <img src="/post_images/2012/08/web_proxy.gif" title="后端代理流程图" alt="web proxy flow chart" /></p>

<p><em>图片来自<code>Yahoo</code></em></p>

<h3>优势</h3>

<p>前端开发人员只要简单地对网址进行<code>encode</code>、拼装就能实现跨域请求，相对其他前端手段，开发难度大大降低。</p>

<h3>代码</h3>

<p>跨域时，前端浏览器向同一域名下的<code>proxy</code>发出请求，要求获取其它域名下的数据（这个请求不跨域），后端再据此对指定地址发出跨域请求（后端<code>curl</code>不受跨域限制），收到响应后后端把响应体重新包装、返回给前端。</p>

<p>整个过程中，前端误以为这是同一域下的结果，也就不会出现限制访问</p>

<p>前端请求本地的<code>webservice/deals.php</code>，这里的<code>deals.php</code>实际上只是一个代理（<code>deals.php</code>可以再改进成通用的<code>proxy</code>）。</p>

<p><em>client page:</em></p>

<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>backbone<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/reset.css&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/lib/zepto.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/lib/datastorage.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/lib/underscore.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/lib/backbone.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="c1">// ROOT_URL = &#39;http://www.gsqmt.dev.sankuai.com/api/v4/dealasync&#39;;</span>
      <span class="kd">var</span> <span class="nx">ROOT_URL</span> <span class="o">=</span> <span class="s1">&#39;/backbone/webservice/deals.php&#39;</span><span class="p">;</span>
 
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateHTTP</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
 
      <span class="kd">var</span> <span class="nx">Deals</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Deal</span>
        <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">ROOT_URL</span>
        <span class="p">,</span> <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="k">new</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
 
      <span class="kd">var</span> <span class="nx">deals</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Deals</span><span class="p">();</span>
      <span class="nx">deals</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
        <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span>
        <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">ROOT_URL</span>
        <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">ws_path</span><span class="o">:</span> <span class="s1">&#39;/path/to/service&#39;</span>
          <span class="p">,</span> <span class="nx">division</span><span class="o">:</span> <span class="s1">&#39;北京&#39;</span>
          <span class="p">,</span> <span class="nx">cate</span><span class="o">:</span> <span class="s1">&#39;1,2,3,4,5&#39;</span>
          <span class="p">,</span> <span class="nx">limit</span><span class="o">:</span> <span class="mi">5</span>
          <span class="p">,</span> <span class="nx">group</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// console.log(collection, res)</span>
          <span class="c1">// deals.add(res.new);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>


<p><em>server proxy:</em></p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="cm">/*</span>
<span class="cm"> * PHP Proxy example</span>
<span class="cm"> * Responds to both HTTP GET and POST requests</span>
<span class="cm"> */</span>
 
<span class="c1">// 要访问的URL_ROOT</span>
<span class="nb">define</span> <span class="p">(</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="p">,</span> <span class="s1">&#39;http://www.meituan.com&#39;</span><span class="p">);</span>
 
<span class="c1">// 设置`REST`请求的路径</span>
<span class="c1">// `POST`还是`GET`请求？</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ws_path&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ws_path&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;ws_path&#39;</span><span class="p">];</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nx">HOSTNAME</span><span class="o">.</span><span class="nv">$path</span><span class="o">.</span><span class="s1">&#39;?&#39;</span><span class="p">;</span>
 
<span class="c1">// `GET`请求的拼接上`queryString`</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;ws_path&#39;</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$element</span> <span class="o">=</span> <span class="nb">current</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">key</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;ws_path&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$url</span> <span class="o">.=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">key</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">))</span><span class="o">.</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="nb">urlencode</span><span class="p">(</span><span class="nv">$element</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nb">next</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 创建一个`curl`的`session`</span>
<span class="nv">$session</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
 
<span class="c1">// 如果是`POST`，将请求数据，放进请求的`body`中</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ws_path&#39;</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$postvars</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$element</span> <span class="o">=</span> <span class="nb">current</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$postvars</span> <span class="o">.=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">key</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span><span class="o">.</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="nb">urlencode</span><span class="p">(</span><span class="nv">$element</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
        <span class="nb">next</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">curl_setopt</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nx">CURLOPT_POST</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="nb">curl_setopt</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nx">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$postvars</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="c1">// 不添加`HTTP`请求头，只有请求内容</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
 
 
<span class="c1">// 发出请求</span>
<span class="nv">$json</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$session</span><span class="p">);</span>
 
<span class="c1">// 根据`web service`返回的数据类型，设置响应的`Content-Type`</span>
<span class="nx">header</span><span class="p">(</span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="p">);</span>
 
 
<span class="k">echo</span> <span class="nv">$json</span><span class="p">;</span>
<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$session</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre>
</div>


<hr />

<h3>参考文档</h3>

<p>JavaScript: Use a Web Proxy for Cross-Domain XMLHttpRequest Calls：<a href="http://developer.yahoo.com/javascript/howto-proxy.html">http://developer.yahoo.com/javascript/howto-proxy.html</a></p>
</div>
      <div class='quick-read-more'><a href='/blog/2012/08/20/web-proxy-for-cross-domain-xmlhttprequest-calls/'>阅读全文...</a></div>
    </div><br />
    </div>
    

  
    <div class='wp-pagenavi'>
      <span class='pages'>Total Pages:4</span>
      
        
          <span class='current'>1</span>
        
      
        
          <a href='/page2/'>2</a>
        
      
        
          <a href='/page3/'>3</a>
        
      
        
          <a href='/page4/'>4</a>
        
      
    </div>
  
</div>
          <div class='home_box' id='home_right'>
            <h2><a href="/aboutme" title="查看详细履历" target="_blank">关于我</a></h2>
            <div id='github-projects'>
              <div class="repo">
                <div class='post'>
                  <div class="aboutme vcard">
                    <a href="/aboutme" title="查看详细履历" target="_blank">
                      <img class="photo" width="82" height="82" style="float:left; margin:5px;" src="http://www.gravatar.com/avatar/6e1bb1a241d9e9fe06980696e21f17fd?s=80">
                    </a>
                    <p><strong>前端攻城湿</strong></p>
                    <p>现就职于<a href="http://meituan.com" _target="blank">美团网</a></p>
                    <p>对新生事物充满强烈好奇心,各种一知半解</p>
                    <blockquote><p><strong>轴</strong></p></blockquote>
                    <p>热爱互联网、热衷命令行，最爱<em><strong>大前端</strong></em></p>
                    <hr />
                    <a href="/aboutme" title="查看详细履历" target="_blank">查看详细履历</a>
                  </div>
                </div>
              </div>
            </div>
            <h2>最新文章</h2>
            <div id='github-projects'>
              <div class="repo">
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/10/22/what-i-should-learned/' style="font-size:0.9em">我要学会的</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/10/21/i%27m-a-stupig-guy.md/' style="font-size:0.9em">i'm a stupig guy</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/08/26/use-nginx-reverse-proxy-for-xmlhttprequest/' style="font-size:0.9em">Web服务器反向代理——跨域的另一种方案</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/08/25/i-do-not-even-know-myself/' style="font-size:0.9em">我不懂我自己</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/08/20/web-proxy-for-cross-domain-xmlhttprequest-calls/' style="font-size:0.9em">后端代理——跨域的另一种方案</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/08/20/use-wget-to-dump-entire-site/' style="font-size:0.9em">使用wget抓取整站资源的脚本</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/08/07/technology-selection-about-html5-storage/' style="font-size:0.9em">Web App或者Hybrid App静态资源管理</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/07/21/thoughts-about--my-early-get-up/' style="font-size:0.9em">好久没有早起</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/07/21/not-a-good-time-to-remember-my-life/' style="font-size:0.9em">何时待追忆</a></div>
                  </div>
                
                  <div class='post'>
                    <div class='body'><a href='/blog/2012/05/22/differences-between-primitive-wrapper-and-literal-variable-and-its-use-in-javascript/' style="font-size:0.9em">JS对象字面量、构造函数包装对象之间的区别和使用</a></div>
                  </div>
                
              </div>
            <div>

            <h2>近期评论</h2>
            <div>
              <div class="repo">
                <div id="recentcomments" class="dsq-widget"><script type="text/javascript" src="http://stupig.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=24&excerpt_length=20"></script></div>
              </div>
            </div>

            <h2>文章分类</h2>
            <div>
              <div class="repo">
                
                  <li><a href="/blog/categories/life/">life(9)</a></li>
                  
                  <li><a href="/blog/categories/tech/">tech(8)</a></li>
                  
                  <li><a href="/blog/categories/work/">work(3)</a></li>
                  
               </div>
            </div>

            <h2>标签</h2>
            <div>
              <div style='padding:5px 5px;' class="repo" >
                <ul style='padding-left:5px; margin: 0px; padding-right: 5px'>
                  
                    <li id='tag-item'><a href="/blog/tags/lover/" name="lover">lover</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/literal-value/" name="literal-value">literal value</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/despise/" name="despise">despise</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/thoughts/" name="thoughts">thoughts</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/responsible/" name="responsible">responsible</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/web-proxy/" name="web-proxy">web proxy</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/responsibility/" name="responsibility">responsibility</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/javascript/" name="javascript">javascript</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/indexed-db/" name="indexed-db">Indexed DB</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/inner-peace/" name="inner-peace">inner peace</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/coding-style/" name="coding-style">coding style</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/negative-energy/" name="negative-energy">negative energy</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/ajax/" name="ajax">Ajax</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/peaceful/" name="peaceful">peaceful</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/trouble/" name="trouble">trouble</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/trusted/" name="trusted">trusted</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/love/" name="love">love</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/postmessage/" name="postmessage">postMessage</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/jsonp/" name="jsonp">JSONP</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/initiative/" name="initiative">initiative</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/linux/" name="linux">Linux</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/anguish/" name="anguish">anguish</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/syntax/" name="syntax">syntax</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/upset/" name="upset">upset</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/family/" name="family">family</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/chinese/" name="chinese">chinese</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/bug/" name="bug">bug</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/english/" name="english">english</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/stupig/" name="stupig">stupig</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/stupid/" name="stupid">stupid</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/art/" name="art">art</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/valentine/" name="valentine">valentine</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/php/" name="php">php</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/ecma/" name="ecma">ECMA</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/bash/" name="bash">bash</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/apache/" name="apache">Apache</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/html/" name="html">html</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/youth/" name="youth">youth</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/web-storage/" name="web-storage">web storage</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/college/" name="college">college</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/class-mates/" name="class-mates">class mates</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/care/" name="care">care</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/wget/" name="wget">wget</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/humility/" name="humility">humility</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/cross-domain/" name="cross-domain">cross domain</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/wander-in-beijing/" name="wander-in-beijing">wander in Beijing</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/css3/" name="css3">css3</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/resources-manager/" name="resources-manager">resources manager</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/answer/" name="answer">answer</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/value/" name="value">value</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/reflection/" name="reflection">reflection</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/girls/" name="girls">girls</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/memories/" name="memories">memories</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/depressive/" name="depressive">depressive</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/css/" name="css">css</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/happy/" name="happy">happy</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/professionalization/" name="professionalization">professionalization</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/remember/" name="remember">remember</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/html5/" name="html5">html5</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/nginx/" name="nginx">Nginx</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/ask/" name="ask">ask</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/high-school/" name="high-school">high school</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/shell/" name="shell">shell</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/application-cache/" name="application-cache">application cache</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/shell-script/" name="shell-script">shell script</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/talk/" name="talk">talk</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/primitive-wrapper/" name="primitive-wrapper">primitive wrapper</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/inline-block/" name="inline-block">inline-block</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/reverse-proxy/" name="reverse-proxy">Reverse Proxy</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/growth/" name="growth">growth</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/markdown/" name="markdown">markdown</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/hack/" name="hack">hack</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/web-sql-database/" name="web-sql-database">Web SQL Database</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/life/" name="life">life</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/mac/" name="mac">Mac</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/soul/" name="soul">soul</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/question/" name="question">question</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/literal-variable/" name="literal-variable">literal variable</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/work/" name="work">work</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/jekyll/" name="jekyll">jekyll</a></li>
                  
                    <li id='tag-item'><a href="/blog/tags/ie6/" name="ie6">ie6</a></li>
                  
                </ul>
               </div>
            </div>

            <!-- <h2>存档</h2>
            <div>
              <div class="repo">
                
                  
                  

                    
                  
                    <li><a href="/archive/ 2012 / 2012 .html">1 2012 1</a></li>
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
                  
                  

                  
                  
                  
                  
                  
                  
              </div>
            </div> -->
            <h2>友情链接</h2>
            <div id='github-projects'>
              <div class="repo">
                <div class='post'>
                  <div class='body'><li><a target='_blank' href='http://www.i607.net' style='font-size:14px' >  607基友  </a></li></div>
                  <div class='body'><li><a target='_blank' href='http://www.chenft.tk' style='font-size:14px' >  砍柴去吧  </a></li></div>
                  <div class='body'><li><a target='_blank' href='http://coolshell.cn/' style='font-size:14px' >  酷 壳  </a></li></div>
                  <div class='body'><li><a target='_blank' href='http://chxt6896.github.com' style='font-size:14px' >  浩宇啸天  </a></li></div>
                  <div class='body'><li><a target='_blank' href='http://www.pizn.net' style='font-size:14px' >  PIZN  </a></li></div>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
    <a style="display: block; " id="gotop" href="#" title="返回顶部" onfocus="this.blur()"> <span><em class="tr">♦</em><em class="tube">▐</em></span></a>
    <div id='footer'>
      <p>
        Copyright &copy; 2012 StuPig. Hosted by <a href='https://github.com/stupig/stupig.github.com' target='_blank'>GitHub</a> and powered by <a href='http://github.com/mojombo/jekyll'>Jekyll</a>.
        <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F29cdc1b12b9f146083eca5268e428aad' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script src="http://s20.cnzz.com/stat.php?id=4003192&web_id=4003192&show=pic2" language="JavaScript"></script>
      </p>
    </div>
    <a href="http://github.com/stupig"><img id="fork_me" style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>
    <!-- <i607>@eQFdzQ2cnS{</i607> -->
    <script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'stupig'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());<!---->

    </script>
  </body>
</html>
